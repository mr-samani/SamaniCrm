<h2 mat-dialog-title cdkDrag cdkDragRootElement=".cdk-overlay-pane">
  <span cdkDragHandle class="title">
     {{ isEditMode ? 'ویرایش احراز هویت خارجی' : 'افزودن احراز هویت خارجی OpenID Connect' }}
  </span>

  <button type="button" class="close-btn" aria-label="Close" mat-dialog-close mat-icon-button>
    <span aria-hidden="true">&times;</span>
  </button>
</h2>
<mat-dialog-content>
 <form [formGroup]="form" class="provider-form">
    
    <!-- Basic Information -->
    <div class="form-section">
      <h3>اطلاعات پایه</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>نام (Name)</mat-label>
        <input matInput formControlName="name" placeholder="مثال: MyCompanyOIDC">
        <mat-hint>نام یکتا برای شناسایی provider</mat-hint>
        <mat-error *ngIf="form.get('name')?.hasError('required')">نام الزامی است</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>نام نمایشی (Display Name)</mat-label>
        <input matInput formControlName="displayName" placeholder="مثال: ورود با حساب شرکتی">
        <mat-hint>نامی که به کاربر نمایش داده می‌شود</mat-hint>
        <mat-error *ngIf="form.get('displayName')?.hasError('required')">نام نمایشی الزامی است</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Scheme (اختیاری)</mat-label>
        <input matInput formControlName="scheme" placeholder="اگر خالی باشد از Name استفاده می‌شود">
        <mat-hint>Scheme یکتا برای authentication handler</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>نوع Provider</mat-label>
        <mat-select formControlName="providerType">
          <mat-option *ngFor="let type of providerTypes" [value]="type.value">
            {{ type.label }}
          </mat-option>
        </mat-select>
        <mat-hint>نوع پروتکل احراز هویت</mat-hint>
      </mat-form-field>
    </div>

    <!-- Client Credentials -->
    <div class="form-section">
      <h3>اطلاعات Client</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Client ID</mat-label>
        <input matInput formControlName="clientId" placeholder="client_id از provider">
        <mat-hint>Client ID دریافتی از OAuth provider</mat-hint>
        <mat-error *ngIf="form.get('clientId')?.hasError('required')">Client ID الزامی است</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Client Secret</mat-label>
        <input 
          matInput 
          [type]="showClientSecret ? 'text' : 'password'" 
          formControlName="clientSecret" 
          placeholder="client_secret از provider">
        <button 
          mat-icon-button 
          matSuffix 
          type="button"
          (click)="toggleClientSecretVisibility()">
          <mat-icon>{{ showClientSecret ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-hint>{{ isEditMode ? 'برای نگه‌داشتن مقدار قبلی خالی بگذارید' : 'Client Secret دریافتی از provider' }}</mat-hint>
        <mat-error *ngIf="form.get('clientSecret')?.hasError('required')">Client Secret الزامی است</mat-error>
      </mat-form-field>
    </div>

    <!-- Endpoints -->
    <div class="form-section">
      <h3>نقاط پایانی (Endpoints)</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Authorization Endpoint</mat-label>
        <input matInput formControlName="authorizationEndpoint" placeholder="https://provider.com/oauth/authorize">
        <mat-hint>آدرس صفحه login در provider</mat-hint>
        <mat-error *ngIf="form.get('authorizationEndpoint')?.hasError('required')">الزامی است</mat-error>
        <mat-error *ngIf="form.get('authorizationEndpoint')?.hasError('pattern')">URL معتبر وارد کنید</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Token Endpoint</mat-label>
        <input matInput formControlName="tokenEndpoint" placeholder="https://provider.com/oauth/token">
        <mat-hint>آدرس دریافت توکن</mat-hint>
        <mat-error *ngIf="form.get('tokenEndpoint')?.hasError('required')">الزامی است</mat-error>
        <mat-error *ngIf="form.get('tokenEndpoint')?.hasError('pattern')">URL معتبر وارد کنید</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>UserInfo Endpoint</mat-label>
        <input matInput formControlName="userInfoEndpoint" placeholder="https://provider.com/oauth/userinfo">
        <mat-hint>آدرس دریافت اطلاعات کاربر</mat-hint>
        <mat-error *ngIf="form.get('userInfoEndpoint')?.hasError('required')">الزامی است</mat-error>
        <mat-error *ngIf="form.get('userInfoEndpoint')?.hasError('pattern')">URL معتبر وارد کنید</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Logout Endpoint (اختیاری)</mat-label>
        <input matInput formControlName="logoutEndpoint" placeholder="https://provider.com/oauth/logout">
        <mat-hint>آدرس logout در provider</mat-hint>
        <mat-error *ngIf="form.get('logoutEndpoint')?.hasError('pattern')">URL معتبر وارد کنید</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Callback Path (اختیاری)</mat-label>
        <input matInput formControlName="callbackPath" placeholder="/signin-oidc">
        <mat-hint>اگر خالی باشد به صورت خودکار تولید می‌شود</mat-hint>
      </mat-form-field>
    </div>

    <!-- OAuth/OIDC Settings -->
    <div class="form-section">
      <h3>تنظیمات OAuth/OIDC</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Scopes</mat-label>
        <input matInput formControlName="scopes" placeholder="openid profile email">
        <mat-hint>Scopes مورد نیاز (با space یا comma جدا شوند)</mat-hint>
        <mat-error *ngIf="form.get('scopes')?.hasError('required')">Scopes الزامی است</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Response Type</mat-label>
        <mat-select formControlName="responseType">
          <mat-option *ngFor="let type of responseTypes" [value]="type.value">
            {{ type.label }}
          </mat-option>
        </mat-select>
        <mat-hint>نوع Flow مورد استفاده</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Response Mode</mat-label>
        <mat-select formControlName="responseMode">
          <mat-option *ngFor="let mode of responseModes" [value]="mode.value">
            {{ mode.label }}
          </mat-option>
        </mat-select>
        <mat-hint>نحوه بازگشت پاسخ</mat-hint>
      </mat-form-field>

      <div class="checkbox-field">
        <mat-checkbox formControlName="usePkce">
          استفاده از PKCE (Proof Key for Code Exchange)
        </mat-checkbox>
        <div class="hint-text">برای امنیت بیشتر توصیه می‌شود</div>
      </div>
    </div>

    <!-- Advanced Settings -->
    <div class="form-section">
      <h3>تنظیمات پیشرفته (اختیاری)</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Metadata JSON</mat-label>
        <textarea 
          matInput 
          formControlName="metadataJson" 
          rows="4"
          placeholder='{"claim_mapping": {"email": "mail"}}'></textarea>
        <mat-hint>تنظیمات JSON برای mapping یا سایر موارد</mat-hint>
      </mat-form-field>
    </div>

  </form>
</mat-dialog-content>
<mat-dialog-actions>
  <button mat-button mat-dialog-close color="cancel">{{ 'Cancel' | translate }}</button>
  <button mat-raised-button color="primary" (click)="onSubmit()" cdkFocusInitial [disabled]="loading || saving">
    @if (saving) {
      <mat-spinner color="primary" diameter="25"></mat-spinner>
    }
    <span>{{ 'Save' | translate }}</span>
  </button>
</mat-dialog-actions>
